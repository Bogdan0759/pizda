ChainFS (CFS) — Спецификация v2.0 (с поддержкой директорий)

## Основные характеристики
- Размер блока: 512 байт (равен стандартному сектору диска)
- Имя файла/директории: 30 байт (фиксировано)
- Макс. размер диска: 2 Терабайта (при 32-битной адресации)
- Структура: **Иерархическая** (поддержка директорий и вложенных путей)
- Порядок байт: Little-Endian
- Макс. размер файла: ~2GB (32-битное поле размера)
- Макс. длина пути: 256 символов

## 1. Карта Диска (Disk Layout)
Диск разбит на 4 четкие зоны. Все адреса — это номера блоков (LBA), начиная с 0.

| Зона       | Старт (Блок) | Размер (Блоков) | Описание                                    |
|------------|--------------|-----------------|---------------------------------------------|
| Superblock | 0            | 1               | Информация о системе + ссылка на root dir  |
| File Table | 1            | M               | Таблица описания файлов и директорий       |
| Block Map  | 1 + M        | N               | Карта цепочек (какой блок идет следующим)  |
| Data Area  | 1 + M + N    | Всё остальное   | Сами данные файлов                         |

Примечание: M (размер таблицы файлов) и N (размер карты блоков) вычисляются при форматировании и записываются в суперблок.
## 2. Структуры данных

### 2.1. Superblock (Блок 0)
Всего 512 байт. Лежит в самом начале диска.

| Смещение | Тип     | Имя                   | Описание                                    |
|----------|---------|----------------------|---------------------------------------------|
| 0x00     | u32     | Magic                | 0xCAFEBABE (Магическое число)              |
| 0x04     | u32     | BlockCount           | Всего блоков на диске                      |
| 0x08     | u32     | FileTableBlockCount  | Размер зоны "File Table" в блоках (M)     |
| 0x0C     | u32     | BlockMapBlockCount   | Размер зоны "Block Map" в блоках (N)      |
| 0x10     | u32     | TotalFiles           | Максимальное число файлов/директорий       |
| 0x14     | u32     | RootDirBlock         | Блок с записью корневой директории         |
| 0x18     | u8[488] | Padding              | Нули                                       |

### 2.2. File Entry (Запись о файле/директории)
Зона File Table — это просто массив вот таких структур.
Размер одной записи: 64 байта.
В один блок (512 байт) влезает ровно 8 записей.

| Смещение | Тип     | Имя         | Описание                                           |
|----------|---------|-------------|---------------------------------------------------|
| 0x00     | u8      | Status      | 0 = Свободно, 1 = Файл/директория существует     |
| 0x01     | u8      | Type        | 0 = Файл, 1 = Директория                         |
| 0x02     | char[30]| Name        | Имя файла/директории (ASCII, завершается нулем)  |
| 0x20     | u32     | Size        | Размер файла в байтах (0 для директорий)         |
| 0x24     | u32     | StartBlock  | Индекс первого блока данных (0 для директорий)   |
| 0x28     | u32     | ParentBlock | Блок родительской директории (0 для root)        |
| 0x2C     | u8[16]  | Reserved    | Зарезервировано (забито нулями)                   |
### 2.3. The Block Map (Карта Цепочек)
Это самое важное упрощение. Вместо битовых карт мы используем массив чисел u32.
Каждый элемент массива соответствует блоку в зоне Data Area.
Значение элемента говорит нам, что делать дальше.

**Значения в Block Map:**
- `0x00000000`: Блок свободен (Free)
- `0xFFFFFFFF`: Конец файла (EOF)
- Любое другое число: Индекс следующего блока этого файла

**Пример:**
Если файл занимает блоки 5, 6 и 9:
- Entry[5] будет равно 6
- Entry[6] будет равно 9  
- Entry[9] будет равно 0xFFFFFFFF (Конец)

## 3. Иерархическая структура директорий

### 3.1. Корневая директория
- Всегда создается при форматировании
- Имеет имя "/" и Type = 1
- ParentBlock = 0 (нет родителя)
- StartBlock = 0 (не нужны блоки данных)

### 3.2. Поиск по пути
Для поиска файла "/test/file.txt":
1. Начинаем с корневой директории (RootDirBlock)
2. Ищем запись с именем "test" и Type = 1 в дочерних элементах root
3. Переходим к найденной директории "test"
4. Ищем запись с именем "file.txt" в дочерних элементах "test"

### 3.3. Дочерние элементы
Дочерние файлы/директории определяются по полю ParentBlock:
- Все записи с ParentBlock = X являются дочерними для директории в блоке X
## 4. Алгоритмы (Как это кодить)

### 4.1. Как прочитать файл "/test/file.txt"
1. **Загрузи Суперблок** (Блок 0). Узнай RootDirBlock
2. **Разбор пути**: Разбей путь на компоненты ["test", "file.txt"]
3. **Поиск директории "test"**:
   - Сканируй File Table, ищи записи где ParentBlock = RootDirBlock
   - Найди запись с Name = "test" и Type = 1
   - Запомни блок этой записи как CurrentDirBlock
4. **Поиск файла "file.txt"**:
   - Сканируй File Table, ищи записи где ParentBlock = CurrentDirBlock  
   - Найди запись с Name = "file.txt" и Type = 0
   - Запомни StartBlock и Size
5. **Чтение данных**: Как в v1.0 - следуй цепочке блоков через Block Map

### 4.2. Как создать файл "/test/newfile.txt"
1. **Разбор пути**: Извлеки родительский путь "/test" и имя файла "newfile.txt"
2. **Найди родительскую директорию**: Используй алгоритм поиска для "/test"
3. **Проверь, что родитель - директория**: Type должен быть 1
4. **Найди свободную запись** в File Table
5. **Создай файл**:
   - Status = 1, Type = 0
   - Name = "newfile.txt"  
   - ParentBlock = блок директории "/test"
   - Выдели блоки данных и заполни StartBlock, Size
6. **Запиши данные**: Как в v1.0

### 4.3. Как создать директорию "/test/newdir"
1. **Разбор пути**: Извлеки родительский путь "/test" и имя "newdir"
2. **Найди родительскую директорию**: "/test"
3. **Найди свободную запись** в File Table
4. **Создай директорию**:
   - Status = 1, Type = 1
   - Name = "newdir"
   - ParentBlock = блок директории "/test"  
   - StartBlock = 0, Size = 0 (директории не используют блоки данных)

### 4.4. Как удалить директорию
1. **Найди директорию** по пути
2. **Проверь, что она пустая**: Не должно быть записей с ParentBlock = этот блок
3. **Удали запись**: Status = 0

## 5. Новые команды Shell

### Команды для работы с директориями:
- `mkdir <path>` - Создать директорию
- `rmdir <path>` - Удалить пустую директорию  
- `cd <path>` - Сменить текущую директорию
- `cd` - Перейти в корень
- `ls` - Показать содержимое текущей директории
- `ls <path>` - Показать содержимое указанной директории
- `mydir` - Показать текущий путь

### Поддержка путей:
- Абсолютные пути: `/test/file.txt`
- Относительные пути: `file.txt`, `subdir/file.txt`
- Максимальная длина пути: 256 символов
## 6. Пример "на пальцах" с директориями

Представь диск на 15 блоков. Блок = 512 байт.

**Блок 0 (Суперблок)**: 
- FileTableSize=2, BlockMapSize=1, RootDirBlock=1

**Блок 1-2 (File Table)**:
```
Блок 1:
  Запись 0: Status=1, Type=1, Name="/", ParentBlock=0      (root dir)
  Запись 1: Status=1, Type=1, Name="test", ParentBlock=1   (test dir)
  Запись 2: Status=1, Type=0, Name="root.txt", ParentBlock=1, Start=0, Size=600
  ...

Блок 2:  
  Запись 0: Status=1, Type=0, Name="file1.txt", ParentBlock=1, Start=2, Size=300
  Запись 1: Status=1, Type=0, Name="deep.txt", ParentBlock=1, Start=4, Size=200
  ...
```

**Блок 3 (Block Map)**: 
```
[1, EOF, 3, EOF, EOF, 0, 0, ...]
Индекс 0: значение 1 (root.txt: блок 0 -> блок 1)
Индекс 1: значение EOF (root.txt: конец)  
Индекс 2: значение 3 (file1.txt: блок 2 -> блок 3)
Индекс 3: значение EOF (file1.txt: конец)
Индекс 4: значение EOF (deep.txt: только один блок)
```

**Блок 4+ (Data Area)**:
```
Физический блок 4: Данные root.txt (часть 1)
Физический блок 5: Данные root.txt (часть 2) 
Физический блок 6: Данные file1.txt (часть 1)
Физический блок 7: Данные file1.txt (часть 2)
Физический блок 8: Данные deep.txt
```

**Структура директорий**:
```
/
├── root.txt (600 байт)
└── test/
    ├── file1.txt (300 байт)  
    └── deep.txt (200 байт)
```

## 7. Лимиты системы

- **Максимальный размер файла**: ~2GB (u32 size field)
- **Максимальный размер диска**: 2TB (u32 block addressing)  
- **Файлы 1KB+**: ✅ Отлично поддерживаются (автоматическое разбиение на блоки)
- **Максимум файлов/директорий**: Настраивается при форматировании
- **Глубина вложенности**: Практически неограниченная
- **Длина имени**: 30 символов
- **Длина пути**: 256 символов